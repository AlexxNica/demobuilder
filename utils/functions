#!/bin/bash -e

interface_ip() {
  ip addr show dev $1 | sed -n '/inet / { s!.*inet !!; s!/.*!!; p; }'
}

apiserver_start() {
  eval $(utils/apiserver.py $(interface_ip $BUILD_BRIDGE))
  export APILISTENER

  export PROXY=$(curl -s http://$APILISTENER/cache)
}

apiserver_stop() {
  kill $APIPID
}

compress_qcow2() {
  BACKINGFILE=$(qemu-img info $1 | sed -n -e '/^backing file: / { s/.*: //; p; }')

  if [ -z $BACKINGFILE ]; then
    qemu-img convert -c -O qcow2 -o compat=0.10 $1 $1.tmp
  else
    qemu-img convert -c -O qcow2 -o compat=0.10 -B $BACKINGFILE $1 $1.tmp
  fi

  mv $1.tmp $1
}

convert_qcow2() {
  if [ $2 = qcow2 ]; then
    qemu-img convert -O $2 -o compat=0.10 $1 $1.tmp
  else
    qemu-img convert -O $2 $1 $1.tmp
  fi

  mv $1.tmp $(echo $1 | sed -e 's/\.[^.]*$//').$2
}

wait_pid() {
  while [ -e /proc/$1 ]; do
    sleep 1
  done
}

read_config() {
  unsetx
  eval $(utils/readconfig.py $1 $2)
  setx
}

needs_build() {
  if [ ! -e $1 ]; then
    return 0
  fi

  if [ "$3" != "" -a "$3" -nt "$1" ]; then
    return 0
  fi

  if [ "$(find $2 -newer $1)" = "" ]; then
    echo "build not needed"
    return 1
  fi
}

unsetx() {
  if [[ $- =~ x ]]; then
    XTRACE=on
  fi

  set +x
}

setx() {
  if [ -n "$XTRACE" ]; then
    set -x
  fi
}

if [ "$DEBUG" ]; then
  set -x
fi

read_config

QEMUKVM=/usr/bin/qemu-kvm
if [ -x /usr/libexec/qemu-kvm ]; then
  QEMUKVM=/usr/libexec/qemu-kvm
fi
